---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# hercacstables

<!-- badges: start -->
<!-- badges: end -->

If this is your first time using `hercacstables` then you probably want to
register with the Census.
The Census limits the number of anonymous API queries that it receives from any
one IP address.
Check out `vignette("set-up-your-api-key", package = "hercacstables")`.

Otherwise, welcome back!

## For the newest R users:

You may be new to R, but not data science, in which case I suggest checking out
[R for Data Science](https://r4ds.hadley.nz/intro.html).
If you're not coming from a data science perspective, I have heard good things
about [this book](https://datascienceineducation.com/).

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("higherX4Racine/hercacstables")
```

## Motivation

The American Community Survey (ACS) from the US Census's website provides a vast
amount of useful data.

![A wordcloud made from the Census' descriptions of its ACS groups](man/figures/README-group-descriptions-wordcloud.png)

However, it returns those data in a weirdly idiosyncratic way.
Even though the output seems tabular, the data are really organized in a
tree-like fashion.
This package is intended to make it easy to access and use the ACS data with R.

## Example

Let's say that you are a data intern for a [wastewater agency](https://cityofracine.org/WasteWater/Commission/) in the
southeastern part of Wisconsin.
Your mentors have asked you to find insights from the American Community Survey.

### Specifying your community

They tell you that the wastewater commission's area of responsibility is
essentially identical to the local school district's,
[Racine Unified](https://www.rusd.org).

You look for geographical levels related to schools in
`hercacstables::ACS_GEOGRAPHY_METADATA`.

```{r}
#| label: look-for-school-geographies
SCHOOL_GEOGRAPHIES <- dplyr::filter(hercacstables::ACS_GEOGRAPHY_METADATA,
                                    grepl("school", .data$`Geographic Level`))
```

This table tells us two things.
First, he geographic level that you should examine is "school district
(unified)".
Second, you also need to specify the state when you're fetching data about it.
With `hercacstables::fetch_data()`, and tools from the [tidyverse][tidyverse],
you can find the FIPS codes for unified school districts in Wisconsin that have
the word "Racine" in them.

```{r}
#| label: find-the-fips-for-racine-unified
RACINE_DISTRICTS <- "NAME" |>
    hercacstables::fetch_data(
        variables = _,
        year = 2020,                           # the most recent decennial
        for_geo = "school district (unified)", # see above
        for_items = "*",                       # this wildcard gets every item
        survey_type = "dec",                   # not actually the ACS *flex*
        table_or_survey_code = "pl",           # this data set is similar to ACS
        state = 55L                            # the Badger State
    ) |>
    dplyr::filter(
        stringr::str_detect(.data$NAME, "Racine")
    )
```

```{r}
#| echo: false

knitr::kable(RACINE_DISTRICTS)
```

### Finding relevant data

The first thing that you could do is to check for data related to plumbing.
If you were doing this without R, you might visit [](data.census.gov) and
search for "ACS plumbing".

#### Groups with relevant data

With `hercacstables`, you would search within its metadata about ACS groups:

```{r}
#| label: search-for-group-about-plumbing

PLUMBING_GROUPS <- hercacstables::ACS_GROUP_METADATA |>
    dplyr::filter(
        grepl("plumbing",          # search for the term "plumbing"
              .data$Description,  # within the "Description" column
              ignore.case = TRUE) # ignore capitalization
    )
```

```{r}
#| label: show-plumbing-groups
#| echo: false

knitr::kable(PLUMBING_GROUPS)
```

It appears that the keyword "plumbing" appears in `r nrow(PLUMBING_GROUPS)`
different ACS groups.

### Specific variables about plumbing

Let's say that "Tenure^[
Whether the occupants rent or own, not if they can't be fired.
] by plumbing facilities" jumps out to you as potentially interesting.

```{r}
#| label: define-group

GROUP <- "B25049"
```

There is metadata in `hercacstables` about variables, too.
You can use search it to see what specific data is reported by group `r GROUP`.

```{r}
#| label: search-for-variables-in-group

PLUMBING_VARIABLES <- hercacstables::ACS_VARIABLE_METADATA |>
    dplyr::filter(
        .data$Dataset == "ACS1", # use the 1-year dataset only
        .data$Group == GROUP     # pull all of the variables for this group
    )
```

```{r}
#| label: show-raw-plumbing-variables
#| echo: false

knitr::kable(PLUMBING_VARIABLES)
```

### Unpacking variable details

You can see that group `r GROUP` reports the number of households that have, or
do not have, plumbing facilities.
It further breaks those households down into renters and owner-occupants.
The raw metadata from the Census, and in `hercacstables::ACS_VARIABLE_METADATA`,
packs all of that information into the "Details" column.

It would be more useful if we actually had separate columns for the types of
tenure and plumbing facilities.
We also don't need row 1, which is the total number of households, or rows 2 and
5, which report subtotals by tenure.
The unique data are in rows 2, 3, 6, and 7.
The best way to do this is to use `hercacstables::unpack_group_details()` in
combination with tools from the [tidyverse][tidyverse]

```{r}
#| label: make-a-helpful-metadata-table
PLUMBING_VARIABLES <- GROUP |>
    hercacstables::unpack_group_details() |>
    dplyr::filter(
        .data$Dataset == "ACS1"
    ) |>
    dplyr::rename(
        Tenure = "A",
        Plumbing = "B"
    ) |>
    dplyr::filter(
        dplyr::if_all(c("Tenure", "Plumbing"),
                      \(.) (nchar(.) > 0))
    )
```

```{r}
#| label: show-plumbing-variables
#| echo: false

knitr::kable(PLUMBING_VARIABLES)
```

### Fetch data

We are finally ready to pull a recent history of access to plumbing in eastern
Racine County.
Once again, we'll use `hercacstables::fetch_data()` and the
[tidyverse][tidyverse].

```{r}
#| label: fetch-racine-plumbing
#| cache: true

RAW_RACINE_PLUMBING <- c(2005:2019, 2021:2023) |>
    purrr::map(
        \(.year) hercacstables::fetch_data(
            variables = PLUMBING_VARIABLES$Variable,
            year = .year,
            for_geo = "school district (unified)",
            for_items = "12360",
            survey_type = "acs",
            table_or_survey_code = "acs1",
            state = 55L
        )
    ) |>
    purrr::list_rbind()
```

```{r}
#| label: show-raw-racine-plumbing
#| echo: false

RAW_RACINE_PLUMBING |>
    dplyr::slice_sample(n = 4) |>
    knitr::kable()
```

The data in `RAW_RACINE_PLUMBING` don't make much sense without the information
in `PLUMBING_VARIABLES`.
Fortunately, we can use the [tidyverse][tidyverse] to join the two tables
together.

```{r}
#| label: wrangle-racine-plumbing

RACINE_PLUMBING <- PLUMBING_VARIABLES |>
    dplyr::left_join(
        RAW_RACINE_PLUMBING,
        by = c("Group", "Index")
    ) |>
    dplyr::select(
        "Year",
        "Tenure",
        "Plumbing",
        Households = "Value"
    )
```

`RACINE_PLUMBING` has `r nrow(RACINE_PLUMBING)` rows, which is too many to show
in a README.
Let's just look at how the number of homes without plumbing has changed over the
years of the ACS.

```{r}
#| label: no-plumbing-in-racine

NO_PLUMBING <- RACINE_PLUMBING |>
    dplyr::filter(
        .data$Plumbing == "Lacking plumbing facilities"
    ) |>
    dplyr::select(
        "Year",
        "Tenure",
        "Households"
    ) |>
    tidyr::pivot_wider(
        names_from = "Tenure",
        values_from = "Households",
        values_fill = NA
    )
```

```{r}
#| label: show-no-plumbing
knitr::kable(NO_PLUMBING)
```

[tidyverse]: https://www.tidyverse.org "The tidyverse"
